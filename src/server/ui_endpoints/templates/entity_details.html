{% extends "base_content.html" %}

{% block title %}{{ name }}{% endblock %}

{% block page_content %}
<div class="max-w-screen-xl mx-auto px-6">
    <div class="flex flex-col md:flex-row gap-4">
        <div class="w-full md:w-1/3 lg:w-1/4">
            <div class="uk-card">
                <div class="uk-card-header space-y-2">
                    <h1 class="uk-h2" id="profile-name">{{ name }}</h1>
                    <input type="text" id="profile-displayname-input" value="{{ name }}" class="p-2 border rounded focus:border-blue-500 w-full uk-h2" style="display: none;" placeholder="Display Name">
                    <p class="text-muted-foreground" id="profile-description-display">{{ description }}</p>
                    <input type="text" id="profile-description-input" value="{{ description }}" class="p-2 border rounded focus:border-blue-500 w-full" style="display: none;" placeholder="Description">
                </div>
                <div class="uk-card-body space-y-2">
                    {% if organization %}
                    <div class="flex items-center" id="profile-organization-display">
                        <uk-icon icon="building" class="mr-1"></uk-icon> {{ organization }}
                    </div>
                    {% endif %}
                    <div class="flex items-start" id="profile-organization-input" style="display: none;">
                        <uk-icon icon="building" class="mr-1 mt-2 flex-shrink-0"></uk-icon>
                        <input type="text" value="{{ organization }}" class="p-2 border rounded focus:border-blue-500 w-full" placeholder="Organization">
                    </div>

                    {% if location %}
                    <div class="flex items-center" id="profile-location-display">
                        <uk-icon icon="map-pin" class="mr-1"></uk-icon> {{ location }}
                    </div>
                    {% endif %}
                    <div class="flex items-start" id="profile-location-input" style="display: none;">
                        <uk-icon icon="map-pin" class="mr-1 mt-2 flex-shrink-0"></uk-icon>
                        <input type="text" value="{{ location }}" class="p-2 border rounded focus:border-blue-500 w-full" placeholder="Location">
                    </div>

                    <div class="mt-3" id="profile-links-display">
                        {% for link in links %}
                        <div class="flex items-center">
                            <uk-icon icon="link" class="mr-1"></uk-icon>
                            <a href="{{ link.url }}" rel="nofollow me">{{ link.url }}</a>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="mt-3" id="profile-links-input" style="display: none;">
                        <div id="profile-links-container">
                            {% for link in links %}
                            <div class="flex items-start mb-2 link-input-group">
                                <uk-icon icon="link" class="mr-1 mt-2 flex-shrink-0"></uk-icon>
                                <input type="text" value="{{ link.url }}" class="p-2 border rounded focus:border-blue-500 w-full link-url" placeholder="Link URL">
                                <button type="button" class="uk-btn uk-btn-danger uk-btn-sm ml-2 flex-shrink-0" onclick="removeLink(this)">
                                    <uk-icon icon="trash"></uk-icon>
                                </button>
                            </div>
                            {% endfor %}
                        </div>
                        <button type="button" class="uk-btn uk-btn-default uk-btn-sm" onclick="addLink()">
                            <uk-icon icon="plus"></uk-icon> Add link
                        </button>
                    </div>

                    {% if logged_in_entity == entity %}
                    <div class="mt-4" id="profile-edit-button">
                        <button type="button" class="uk-btn uk-btn-default uk-btn-sm w-full text-center" onclick="enableProfileEdit()">
                            Edit profile
                        </button>
                    </div>
                    <div class="mt-4" id="profile-save-buttons" style="display: none;">
                        <button type="button" class="uk-btn uk-btn-default uk-btn-sm" onclick="cancelProfileEdit()">
                            Cancel
                        </button>
                        <button type="button" class="uk-btn uk-btn-primary uk-btn-sm ml-2" onclick="saveProfile()">
                            Save
                        </button>
                    </div>
                    <div id="profile-update-error" class="mt-2"></div>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="w-full md:w-2/3 lg:w-3/4">
            <div class="uk-card-header space-y-2 pr-0 flex justify-between items-center">
                <h2 class="uk-h2">Databases</h2>
                <button type="button"></button>
                {% if can_create_database %}
                <button
                    data-uk-toggle="target: #create-database-form"
                    class="uk-btn {% if databases | length == 0 %}uk-btn-primary{% else %}uk-btn-default{% endif %} uk-btn-sm">
                    <uk-icon icon="plus"></uk-icon> Create database
                </button>
                {% endif %}
            </div>
            <div class="uk-card-body space-y-2 pr-0">
                <hr class="uk-hr" />

                {% if can_create_database %}
                <div id="create-database-form" hidden>
                  <div class="block hover:bg-gray-50 uk-card">
                    <h3 class="uk-h3 flex uk-card-header font-normal pb-0">Create a new database</h3>
                    <div class="uk-card-body">
                        <form
                          class="mt-4"
                          hx-post="/{{ entity }}/create_database"
                          hx-target-400="#create-database-error"
                          hx-swap="innerHTML">
                            <div class="mb-4">
                                <label for="database-slug" class="block text-sm font-medium mb-1">Database name</label>
                                <input
                                    type="text"
                                    id="database-slug"
                                    name="database_slug"
                                    class="p-2 border rounded focus:border-blue-500"
                                    placeholder="example.sqlite"
                                    pattern="[A-Za-z0-9\-_\.]+"
                                    title="Only letters, numbers, underscores, hyphens, and periods are allowed"
                                    required>
                            </div>

                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-1">Public sharing level</label>
                                <div class="uk-btn-group" data-uk-button-radio>
                                    <button
                                        type="button"
                                        class="uk-btn uk-btn-default uk-active"
                                        data-value="no-access"
                                        onclick="setPublicSharingLevel(this, 'no-access')">
                                        Private
                                    </button>
                                    <button
                                        type="button"
                                        class="uk-btn uk-btn-default"
                                        data-value="fork"
                                        onclick="setPublicSharingLevel(this, 'fork')">
                                        Forkable
                                    </button>
                                    <button
                                        type="button"
                                        class="uk-btn uk-btn-default"
                                        data-value="read-only"
                                        onclick="setPublicSharingLevel(this, 'read-only')">
                                        Read-only
                                    </button>
                                </div>
                                <input type="hidden" id="public-sharing-level" name="public_sharing_level" value="no-access">
                            </div>
                            <div class="mt-4">
                                <button type="submit" id="create-database-submit" class="uk-btn uk-btn-primary">
                                    Create database
                                </button>
                            </div>
                        </form>
                    </div>

                    <div id="create-database-error" class="mx-4 mb-4"></div>

                    <script>
                        function setPublicSharingLevel(button, value) {
                            // Update the hidden input value
                            document.getElementById('public-sharing-level').value = value;

                            // Update button states
                            const buttons = button.parentElement.querySelectorAll('button');
                            buttons.forEach(btn => {
                                btn.classList.remove('uk-active');
                            });
                            button.classList.add('uk-active');
                        }

                        // Form is submittable once a slug exists.
                        document.addEventListener('DOMContentLoaded', function() {
                            const databaseSlug = document.getElementById('database-slug');
                            const submitButton = document.getElementById('create-database-submit');
                            submitButton.disabled = databaseSlug.value.trim() === '';
                            databaseSlug.addEventListener('input', function() {
                                submitButton.disabled = this.value.trim() === '';
                            });
                        });
                    </script>
                  </div>
                </div>
                {% endif %}

                {% if databases | length == 0 %}
                <div class="block uk-card">
                    <h3 class="uk-h3 flex space-y-2 uk-card-header font-normal">No databases...yet!</h3>
                    <p class="uk-card-body space-y-2">Let's fix that by creating your first database.</p>
                </div>
                {% else %}
                    {% for db in databases %}
                    <a href="{{ entity }}/{{ db.slug }}" class="block hover:bg-gray-50 uk-card">
                        <h3 class="uk-h3 flex space-y-2 uk-card-header font-normal" style="align-items: baseline;">
                            <uk-icon icon="database" class="mr-1"></uk-icon>{{ db.slug }} <uk-icon icon="chevron-right"></uk-icon>
                        </h3>
                        <p class="text-muted-foreground uk-card-body space-y-2">Type: {{ db.database_type }}</p>
                    </a>
                    {% endfor %}
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
function enableProfileEdit() {
    // Hide display elements
    document.getElementById('profile-name').style.display = 'none';
    document.getElementById('profile-description-display').style.display = 'none';
    document.getElementById('profile-organization-display').style.display = 'none';
    document.getElementById('profile-location-display').style.display = 'none';
    document.getElementById('profile-links-display').style.display = 'none';
    document.getElementById('profile-edit-button').style.display = 'none';

    // Show input elements
    document.getElementById('profile-displayname-input').style.display = 'block';
    document.getElementById('profile-description-input').style.display = 'block';
    document.getElementById('profile-organization-input').style.display = 'flex';
    document.getElementById('profile-location-input').style.display = 'flex';
    document.getElementById('profile-links-input').style.display = 'block';
    document.getElementById('profile-save-buttons').style.display = 'block';

    // Clear any previous errors
    document.getElementById('profile-update-error').innerHTML = '';
}

function cancelProfileEdit() {
    // Show display elements
    document.getElementById('profile-description-display').style.display = 'block';
    const orgDisplay = document.getElementById('profile-organization-display');
    if (orgDisplay) orgDisplay.style.display = 'flex';
    const locDisplay = document.getElementById('profile-location-display');
    if (locDisplay) locDisplay.style.display = 'flex';
    document.getElementById('profile-links-display').style.display = 'block';
    document.getElementById('profile-edit-button').style.display = 'block';

    // Hide input elements
    document.getElementById('profile-description-input').style.display = 'none';
    document.getElementById('profile-organization-input').style.display = 'none';
    document.getElementById('profile-location-input').style.display = 'none';
    document.getElementById('profile-links-input').style.display = 'none';
    document.getElementById('profile-save-buttons').style.display = 'none';

    // Reset values
    window.location.reload();
}

function addLink() {
    const container = document.getElementById('profile-links-container');
    const linkDiv = document.createElement('div');
    linkDiv.className = 'flex items-start mb-2 link-input-group';
    linkDiv.innerHTML = `
        <uk-icon icon="link" class="mr-1 mt-2 flex-shrink-0"></uk-icon>
        <input type="text" value="" class="p-2 border rounded focus:border-blue-500 w-full link-url" placeholder="Link URL">
        <button type="button" class="uk-btn uk-btn-danger uk-btn-sm ml-2 flex-shrink-0" onclick="removeLink(this)">
            <uk-icon icon="trash"></uk-icon>
        </button>
    `;
    container.appendChild(linkDiv);
}

function removeLink(button) {
    button.closest('.link-input-group').remove();
}

async function saveProfile() {
    const displayName = document.querySelector('#profile-displayname-input').value;
    const description = document.querySelector('#profile-description-input').value;
    const organization = document.querySelector('#profile-organization-input input').value;
    const location = document.querySelector('#profile-location-input input').value;

    // Clear any previous errors
    document.getElementById('profile-update-error').innerHTML = '';

    // Collect links
    const linkInputs = document.querySelectorAll('.link-url');
    const links = Array.from(linkInputs)
        .map(input => input.value.trim())
        .filter(url => url.length > 0)
        .map(url => ({ url: url }));

    const profileData = {
        display_name: displayName || null,
        description: description || null,
        organization: organization || null,
        location: location || null,
        links: JSON.stringify(links)
    };

    try {
        const response = await fetch('/{{ entity }}/update_profile', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(profileData)
        });

        if (response.ok) {
            // Reload the page to show updated data
            window.location.reload();
        } else {
            const errorHtml = await response.text();
            // Display the error HTML in the error container
            document.getElementById('profile-update-error').innerHTML = errorHtml;
        }
    } catch (error) {
        // For network errors, display a simple error message
        document.getElementById('profile-update-error').innerHTML = `
            <div class="uk-alert uk-alert-destructive" data-uk-alert="">
                <div class="uk-alert-title">Error updating profile</div>
                <p>${error.message}</p>
            </div>
        `;
    }
}
</script>
{% endblock %}
