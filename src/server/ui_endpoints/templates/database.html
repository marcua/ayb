{% extends "base_content.html" %}

{% block title %}Explore {{ entity }}/{{ database }}{% endblock %}

{% block page_content %}
<div class="max-w-screen-xl mx-auto px-6">
    <div class="max-w-screen-xl mx-auto">
        <div class="breadcrumbs mb-4">
            <a href="/{{ entity }}" class="hover:underline">{{ entity }}</a> / 
            <span class="font-semibold">{{ database }}</span> ({{ database_type }})
        </div>
        <ul data-uk-tab class="mb-6">
            <li class="uk-active"><a class="px-4 pb-3 pt-2" href="">Query</a></li>
            {% if can_manage_database %}
                <li><a class="px-4 pb-3 pt-2" href="">Sharing</a></li>
                <li><a class="px-4 pb-3 pt-2" href="">Snapshots</a></li>
            {% endif %}
        </ul>
        <ul class="uk-switcher mt-4">
            <li>
                {% if highest_query_access_level %}
                    <div class="query-interface">
                        <h3 class="text-lg font-medium mb-2">Database querying</h3>
                        <p class="text-muted-foreground mb-4">Select, add, and update data.</p>
                        <form
                          id="query-form"
                          class="mb-4"
                          action="/{{ entity }}/{{ database }}/query"
                          method="post"
                          hx-post="/{{ entity }}/{{ database }}/query"
                          hx-target="#query-results"
                          hx-target-400="#query-results"
                          hx-swap="innerHTML">
                            <div class="mb-2">
                                <textarea id="query" name="query" rows="5"
                                    class="p-4 w-full border rounded focus:border-blue-500"
                                    placeholder="Enter a SQL query, like 'SELECT * FROM your_table LIMIT 10'"></textarea>
                            </div>
                            <div>
                                <button type="submit" class="uk-btn uk-btn-primary" disabled id="run-query-btn">
                                    Run query
                                </button>
                                <script>
                                    // Form is submittable once a query exists.
                                    document.addEventListener('DOMContentLoaded', function() {
                                        const queryTextarea = document.getElementById('query');
                                        const runButton = document.getElementById('run-query-btn');
                                        runButton.disabled = queryTextarea.value.trim() === '';
                                        queryTextarea.addEventListener('input', function() {
                                            runButton.disabled = this.value.trim() === '';
                                        });
                                    });
                                </script>
                            </div>
                        </form>
                        <div id="query-results">
                        </div>
                    </div>
                {% else %}
                    <div class="uk-alert uk-alert-destructive" data-uk-alert="">
                        <div class="uk-alert-title">You don't have query access to this database.</div>
                        <p>You can request access from the database owner or fork a copy.</p>
                    </div>
                {% endif %}
            </li>
            <li>
                <div class="sharing-interface">
                    <h3 class="text-lg font-medium mb-2">Database sharing</h3>
                    <p class="text-muted-foreground mb-4">Manage who can access this database and what permissions they have.</p>

                    <!-- Public sharing level form -->
                    <div class="uk-card uk-card-default mb-4">
                        <div class="uk-card-header">
                            <h4 class="uk-card-title">Public sharing level</h4>
                        </div>
                        <div class="uk-card-body">
                            <form id="public-sharing-form" class="space-y-4">
                                <div class="uk-btn-group" data-uk-button-radio>
                                    <button
                                        type="button"
                                        class="uk-btn uk-btn-default{% if public_sharing_level == 'no-access' %} uk-active{% endif %}"
                                        data-value="no-access"
                                        onclick="setPublicSharingLevel(this, 'no-access')">
                                        Private
                                    </button>
                                    <button
                                        type="button"
                                        class="uk-btn uk-btn-default{% if public_sharing_level == 'fork' %} uk-active{% endif %}"
                                        data-value="fork"
                                        onclick="setPublicSharingLevel(this, 'fork')">
                                        Forkable
                                    </button>
                                    <button
                                        type="button"
                                        class="uk-btn uk-btn-default{% if public_sharing_level == 'read-only' %} uk-active{% endif %}"
                                        data-value="read-only"
                                        onclick="setPublicSharingLevel(this, 'read-only')">
                                        Read-only
                                    </button>
                                </div>
                                <input type="hidden" id="public-sharing-level-value" name="public_sharing_level" value="">
                                <div>
                                    <button type="button" id="update-public-sharing-btn" class="uk-btn uk-btn-primary" disabled
                                            hx-post="/{{ entity }}/{{ database }}/update_public_sharing"
                                            hx-target="#public-sharing-error"
                                            hx-target-400="#public-sharing-error"
                                            hx-swap="innerHTML"
                                            hx-include="#public-sharing-level-value">
                                        Update sharing level
                                    </button>
                                </div>
                            </form>
                            <div id="public-sharing-error" class="mt-2"></div>
                        </div>
                    </div>

                    <!-- Share with specific entity form -->
                    <div class="uk-card uk-card-default">
                        <div class="uk-card-header">
                            <h4 class="uk-card-title">Share with specific user</h4>
                        </div>
                        <div class="uk-card-body">
                            <form id="entity-sharing-form" class="space-y-4"
                                  hx-post="/{{ entity }}/{{ database }}/share"
                                  hx-target="#entity-sharing-error"
                                  hx-target-400="#entity-sharing-error"
                                  hx-swap="innerHTML">
                                <div>
                                    <label for="share-entity" class="block text-sm font-medium mb-1">Username</label>
                                    <input
                                        type="text"
                                        id="share-entity"
                                        name="entity"
                                        class="p-2 border rounded focus:border-blue-500"
                                        placeholder="Enter username"
                                        onInput="checkEntitySharingForm()"
                                        required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">Access level</label>
                                    <div class="uk-btn-group" data-uk-button-radio>
                                        <button
                                            type="button"
                                            class="uk-btn uk-btn-default"
                                            data-value="no-access"
                                            onclick="setEntitySharingLevel(this, 'no-access')">
                                            No access
                                        </button>
                                        <button
                                            type="button"
                                            class="uk-btn uk-btn-default"
                                            data-value="read-only"
                                            onclick="setEntitySharingLevel(this, 'read-only')">
                                            Read-only
                                        </button>
                                        <button
                                            type="button"
                                            class="uk-btn uk-btn-default"
                                            data-value="read-write"
                                            onclick="setEntitySharingLevel(this, 'read-write')">
                                            Read-write
                                        </button>
                                        <button
                                            type="button"
                                            class="uk-btn uk-btn-default"
                                            data-value="manager"
                                            onclick="setEntitySharingLevel(this, 'manager')">
                                            Manager
                                        </button>
                                    </div>
                                    <input type="hidden" id="entity-sharing-level-value" name="sharing_level" value="">
                                </div>
                                <div>
                                    <button type="submit" id="share-entity-btn" class="uk-btn uk-btn-primary" disabled>
                                        Update access
                                    </button>
                                </div>
                            </form>
                            <div id="entity-sharing-error" class="mt-2"></div>
                        </div>
                    </div>

                    <script>
                        let originalPublicSharingLevel = '';
                        let selectedPublicSharingLevel = '';
                        let selectedEntitySharingLevel = '';

                        function setPublicSharingLevel(button, value) {
                            selectedPublicSharingLevel = value;
                            document.getElementById('public-sharing-level-value').value = value;

                            // Update button states
                            const buttons = button.parentElement.querySelectorAll('button');
                            buttons.forEach(btn => {
                                btn.classList.remove('uk-active');
                            });
                            button.classList.add('uk-active');

                            // Enable/disable update button based on whether value changed
                            const updateBtn = document.getElementById('update-public-sharing-btn');
                            updateBtn.disabled = (value === originalPublicSharingLevel);
                        }

                        function setEntitySharingLevel(button, value) {
                            selectedEntitySharingLevel = value;
                            document.getElementById('entity-sharing-level-value').value = value;

                            // Update button states
                            const buttons = button.parentElement.querySelectorAll('button');
                            buttons.forEach(btn => {
                                btn.classList.remove('uk-active');
                            });
                            button.classList.add('uk-active');

                            checkEntitySharingForm();
                        }

                        function checkEntitySharingForm() {
                            const entityInput = document.getElementById('share-entity');
                            const submitBtn = document.getElementById('share-entity-btn');
                            const hasEntity = entityInput.value.trim() !== '';
                            const hasLevel = selectedEntitySharingLevel !== '';
                            submitBtn.disabled = !(hasEntity && hasLevel);
                        }

                        // Initialize form state when page loads
                        document.addEventListener('DOMContentLoaded', function() {
                            // Set initial public sharing level from the backend
                            originalPublicSharingLevel = '{{ public_sharing_level }}';
                            const currentButton = document.querySelector('[data-value="{{ public_sharing_level }}"]');
                            if (currentButton) {
                                setPublicSharingLevel(currentButton, '{{ public_sharing_level }}');
                            }

                            // Listen for successful HTMX requests to update the original value
                            document.body.addEventListener('htmx:afterRequest', function(event) {
                                if (event.detail.xhr.status === 200 && event.target.id === 'update-public-sharing-btn') {
                                    // Update the original value to the newly selected value
                                    originalPublicSharingLevel = selectedPublicSharingLevel;
                                    // Disable the button since it now matches the original value
                                    event.target.disabled = true;
                                }
                            });
                        });
                    </script>
                </div>
            </li>
            <li>
                <div class="snapshots-interface">
                    <h3 class="text-lg font-medium mb-2">Database snapshots</h3>
                    <p class="text-muted-foreground mb-4">View and restore database snapshots.</p>
                    <p class="text-sm">Use the command line to manage snapshots:</p>
                    <pre class="bg-muted p-2 rounded mt-1 text-sm">ayb client list_snapshots {{ entity }}/{{ database }}</pre>
                    <pre class="bg-muted p-2 rounded mt-1 text-sm">ayb client restore_snapshot {{ entity }}/{{ database }} [snapshot-id]</pre>
                </div>
            </li>
        </ul>
    </div>
</div>
{% endblock %}
