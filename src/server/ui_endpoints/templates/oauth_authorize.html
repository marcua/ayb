{% extends "base_content.html" %}

{% block title %}Authorize {{ app_name }}{% endblock %}

{% block page_content %}
<div class="max-w-md mx-auto px-6 py-8">
    <div class="bg-white rounded-lg shadow-sm p-6">
        <h1 class="text-2xl font-bold mb-2">Authorize application</h1>
        <p class="text-muted-foreground mb-6">
            <strong>{{ app_name }}</strong> wants to access one of your databases.
        </p>

        <form method="POST" action="/oauth/authorize" class="space-y-6">
            <!-- Hidden fields to preserve OAuth state -->
            <input type="hidden" name="redirect_uri" value="{{ redirect_uri }}">
            <input type="hidden" name="state" value="{{ state }}">
            <input type="hidden" name="code_challenge" value="{{ code_challenge }}">
            <input type="hidden" name="app_name" value="{{ app_name }}">
            <input type="hidden" name="requested_scope" value="{{ requested_scope }}">

            <!-- Database selection -->
            <div>
                <label class="block text-sm font-medium mb-2">Select a database</label>
                {% if databases | length == 0 %}
                <p class="text-muted-foreground text-sm mb-2">
                    You don't have any databases yet.
                    <a href="/{{ entity }}" class="text-primary hover:underline" target="_blank">Create one first</a>,
                    then return here.
                </p>
                {% else %}
                <select name="database_id" required class="uk-select w-full">
                    {% for db in databases %}
                    <option value="{{ db.id }}">{{ entity }}/{{ db.slug }}</option>
                    {% endfor %}
                </select>
                {% endif %}
            </div>

            <!-- Permission level selection -->
            <div>
                <label class="block text-sm font-medium mb-2">Permission level</label>
                <p class="text-muted-foreground text-sm mb-2">
                    {{ app_name }} is requesting <strong>{{ requested_scope }}</strong> access.
                    You can grant less permission than requested.
                </p>
                <div class="space-y-2">
                    <label class="flex items-center space-x-2">
                        <input type="radio" name="permission_level" value="read-only"
                               class="uk-radio" {% if requested_scope == "read-only" %}checked{% endif %}>
                        <span>Read only</span>
                        <span class="text-muted-foreground text-sm">- Can only read data</span>
                    </label>
                    <label class="flex items-center space-x-2">
                        <input type="radio" name="permission_level" value="read-write"
                               class="uk-radio" {% if requested_scope == "read-write" %}checked{% endif %}
                               {% if requested_scope == "read-only" %}disabled{% endif %}>
                        <span>Read and write</span>
                        <span class="text-muted-foreground text-sm">- Can read and modify data</span>
                    </label>
                </div>
            </div>

            <!-- Warning about what the app can do -->
            <div class="bg-amber-50 border border-amber-200 rounded p-3 text-sm">
                <p class="text-amber-800">
                    <strong>Note:</strong> By authorizing, you grant {{ app_name }} access to
                    query the selected database with the chosen permission level. You can
                    revoke this access anytime from your
                    <a href="/settings/tokens" class="underline" target="_blank">token settings</a>.
                </p>
            </div>

            <!-- Action buttons -->
            <div class="flex space-x-3">
                <button type="submit" name="action" value="deny"
                        class="uk-btn uk-btn-default flex-1">
                    Deny
                </button>
                <button type="submit" name="action" value="authorize"
                        class="uk-btn uk-btn-primary flex-1"
                        {% if databases | length == 0 %}disabled{% endif %}>
                    Authorize
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}
